---
title: "Electric Vehicle Pricing"
author: "Eric Wilson; Min Thiha Myo; Kevin Maldonado"
date: "12/7/2021"
output:
  html_document: default
  pdf_document: default
---

# Introduction

Electric Vehicles are rising in popularity amongst consumers in todays day and age. With climate change playing a big factor,
several nations have made a consorted effort in investing in 'green technologies' which include electric vehicles. The development
and improvement of battery technology has made the electric vehicle a viable and perhaps a more preferable choice for consumers.
Some of the advantages of electric vehicles include saving money on gas, environmentally friendly, low maintenance cost. Local 
governments are also offering incentives to buy an electric vehicle. As there is with any new technology, there are challenges 
that electric vehicles face. Charging station scarcity and battery range are 2 big hurdles that owners will have to face. Despite
the challenges that owners and manufactures might have to overcome, the rise of ownership of electric vehicles is undeniable and
will only increase heading into the future. 

Our project will take data from various electric vehicles that are available in the market and from that data we will perform a regression analysis
to predict the price of electric vehicles based on different variables such as battery size, acceleration, range and efficiency. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(MASS)
library(car)
library(corrplot)
library(patchwork)
library(leaps)
```

# Data Preparation

## Data Source
Our data can be found through this link: https://www.kaggle.com/kkhandekar/cheapest-electric-cars

##Loading Dataset
Our EV dataset contains 180 observations (rows) and 12 variables (columns). 
```{r}
ev <- read_xlsx('Electric Vehicle Data/Cheapestelectriccars-EVDatabase.xlsx', 
                sheet = 'Cheapestelectriccars- UTF8')
```

## Data Cleanup
We now go into our data and start our clean up process. We start by converting several variables to numeric. Battery Size, PriceinUK, 
Acceleration, Top Speed, Range, Efficiency, Fast charge speed, and Price in Germany all get converted to numeric. Along with this conversion,
we perform some regex (regular expression) to our data so that we can perform a successful conversion to numeric. Our 'Drive' variable will 
be converted to a factor. Note that since our data set comes from european sources the units will be in kilometers.
```{r}
# Convert Character Vectors into useable numeric vectors
ev$BatterySize <- as.numeric(gsub(".* ([0-9]{2,3}[.]*[0-9]*) kWh", "\\1", ev$Subtitle))
libra_strip <- gsub(".([0-9]{2,3},[0-9]{3})", "\\1", ev$PriceinUK) # strip the libra symbol
ev$PriceinUK <- as.numeric(gsub(",", "", libra_strip))
ev$Acceleration <- as.numeric(gsub(" sec", "", ev$Acceleration))
ev$TopSpeed <- as.numeric(gsub(" km/h", "", ev$TopSpeed))
ev$Range <- as.numeric(gsub(" km", "", ev$Range))
ev$Efficiency <- as.numeric(gsub(" Wh/km", "", ev$Efficiency))
ev$FastChargeSpeed <- as.numeric(gsub(" km/h", "", ev$FastChargeSpeed))
ev$Drive <- as.factor(ev$Drive)
ev$PriceinGermany <- as.numeric(ev$PriceinGermany)
ev <- ev[,-2] #removing subtitle column
```
We then check for any missing values in our data set and remove them.
```{r}
# Limit ev to complete records, German Prices
ev <- ev[complete.cases(cbind(ev$FastChargeSpeed, ev$PriceinGermany)),]
attach(ev)
```

# Exploratory Data Analysis
Let's to a look at our data set now that we have removed missing values and cleaned it up.
```{r}
head(ev)
```
We have data available for EV prices in Germany (in euros) and prices in the UK (pound sterling ), but for the purpose of this report
we will only be using prices in Germany as our response variable since it provides more data points.

## Summary of Variables
```{r}
#summary of Battery Size
summary(BatterySize)
```
```{r}
#summary of EV prices in Germany
summary(PriceinGermany)
```

```{r}
#summary of Top speed
summary(TopSpeed)
```

```{r}
#summary of Battery Range
summary(Range)
```
The electric vehicles in our data set range in price from €20,490 to €215,000 with an average price of €59,645.
Battery size ranges from 23.8kWh to 200kWh with an average battery size of 66.73kWh
The battery range ranges from 165km to 970km
Top speed ranges from 123km/h to 410km/h with an average top speed of 177.7km/h

## Correlation
```{r}
ev_numeric <- ev[, -c(1,7,10 )] #Creating numeric data frame for correlation plots and removing price in UK
pairs(PriceinGermany~., ev_numeric)
```
This scatter plot matrices shows the correlation that exists between variables. Starting from the top left, the variables
move downward diagonally and is an axis label for the plots shown. With these scatterplots we can see that there is some correlation
between PriceinGermany and top speed, range, fast charging speed and battery size. These plots might be a little difficult to read
so lets do a different correlation plot.


```{r}
corrplot(cor(ev_numeric), method = "number")
```
This correlation plot is also a correlation matrix. We us the argument "method = number" to show the coefficients in a number 
with different colors that describe their respective correlation. Confirming with what we saw in the scatterplot matrix, we can
easily identify the correlation between PriceinGermany and top speed, range, fast charge speed and battery size. 



## Distribution of EV Prices
Taking a more in depth look in EV prices, we will graph the distribution of the prices as well as mark the median and mean
```{r}
ggplot(ev_numeric, aes(x = PriceinGermany)) +    
  geom_histogram(alpha = 0.8,fill = "#fcb9c6") +
  geom_vline(aes(xintercept = mean(PriceinGermany)),col='indianred1',size=1)+ #Vertical Line for Mean
  geom_text(aes(x=mean(PriceinGermany) + 1250, label="Mean", y=10), colour="indianred1", angle=90) +
  geom_vline(aes(xintercept = median(PriceinGermany)),col='steelblue1',size=1)+ #Vertical Line for Median
  geom_text(aes(x=median(PriceinGermany) + 1250, label="Median", y=10), colour="steelblue1", angle=90) +
  labs(x= 'Price',y = 'Count', title = paste("Distribution of EV Prices")) +
  theme_bw()
```
Now we will look at the relationship price has with acceleration, top speed, range and efficiency
```{r}
v1 <- ggplot(ev_numeric, aes(x=Acceleration,y=PriceinGermany))+
  geom_point(color = "blue")+
  
  stat_smooth(aes(x=Acceleration,y=PriceinGermany),method="lm", color="red")+ #code for trend line
  theme_bw()+
  labs(x = 'Acceleration', 
       y = 'Price', 
       title = 'Acceleration and Price')

v2 <- ggplot(ev_numeric, aes(x=TopSpeed,y=PriceinGermany))+
  geom_point(color = "blue")+
  
  stat_smooth(aes(x=TopSpeed,y=PriceinGermany),method="lm", color="red")+ #code for trend line
  theme_bw()+
  labs(x = 'Top Speed', 
       y = 'Price', 
       title = 'Top Speed and Price')


v3 <- ggplot(ev_numeric, aes(x=Range,y=PriceinGermany))+
  geom_point(color = "blue")+
  
  stat_smooth(aes(x=Range,y=PriceinGermany),method="lm", color="red")+ #code for trend line
  theme_bw()+
  labs(x = 'Range', 
       y = 'Price', 
       title = 'Range and Price')


v4 <- ggplot(ev_numeric, aes(x=Efficiency,y=PriceinGermany))+
  geom_point(color = "blue")+
  
  stat_smooth(aes(x=Efficiency,y=PriceinGermany),method="lm", color="red")+ #code for trend line
  theme_bw()+
  labs(x = 'Efficiency', 
       y = 'Price', 
       title = 'Efficiency and Price')

patch = v1 + v2 + v3 + v4 + plot_layout(ncol=2, nrow=2) #patching all graphs in one frame
patch
```
## Initial Model

Our initial model regresses the Price in Germany on the numerical predictors.

```{r}
initial_model <- lm(PriceinGermany ~ Acceleration + TopSpeed + Range + Efficiency
                    + FastChargeSpeed + NumberofSeats + BatterySize, data = ev)
summary(initial_model)
plot(initial_model)
```

The initial model is not valid. Normal Q-Q is not close to a line, and the standardized residuals show changing variance.

## Data Transformation
We address these issue by transforming our data. We run multivariagte Box-Cox transformation on our predictors and our response.
```{r}
# Transform response and numeric predictors
summary(powerTransform(cbind(PriceinGermany, Acceleration, TopSpeed, Range, Efficiency,
                             FastChargeSpeed, BatterySize) ~ 1, data = ev))
```

We will choose $\lambda = -1$ for `PriceinGermany` and `TopSpeed`, $\lambda = .5$ for `Acceleration`, and $\lambda = 0$ for all other variables.

```{r}
# Create model with transformed Data
transformed_model <- lm(1/PriceinGermany ~ sqrt(Acceleration) + I(1/TopSpeed) + log(Range) +
                 log(Efficiency) + log(FastChargeSpeed) + log(BatterySize), data = ev)
summary(transformed_model)
```

Not all of our predictors are statistically significant.

## Feature Selection
We perform feature selection to address the insignificant variables.
```{r}
# Perform Best Subset Selection on Transformed Data
transformed_model_subsets <- regsubsets(x = 1/PriceinGermany ~ sqrt(Acceleration) + I(1/TopSpeed)
                             + log(Range) +log(Efficiency) + log(FastChargeSpeed)
                             + log(BatterySize) + log(NumberofSeats), data = ev)
(transformed_model_subsets.summary <- summary(transformed_model_subsets))
(best_number_variables <- list("AIC" = which.min(transformed_model_subsets.summary$cp), "BIC" = which.min(transformed_model_subsets.summary$bic),
                              "R2adj" = which.max(transformed_model_subsets.summary$adjr2)))
```

We choose to use the smallest model suggest by the Bayesian information criterion.

## Best Subset Model
```{r}
# Create model with transformed Data, without FastChargeSpeed
subset_model <- lm(1/PriceinGermany ~ I(1/TopSpeed) + log(Range) + 
                 log(Efficiency) + log(BatterySize), data = ev)
summary(subset_model)
plot(subset_model)
```

In this model, Normal Q-Q is close to linear, and variance is reasonably constant. The model appears to be valid.
An outlier is clearly seen with the Lightyear One car, which at the time of this project has not come to market but is priced at 149,000 Euros.